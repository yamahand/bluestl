name: CI

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]

jobs:
  build-and-test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        compiler: [gcc, clang]
        exclude:
          - os: windows-latest
            compiler: gcc
        include:
          - os: windows-latest
            compiler: msvc

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup C++ (Linux/macOS GCC)
      if: matrix.os != 'windows-latest' && matrix.compiler == 'gcc'
      run: |
        if [ "$RUNNER_OS" == "Linux" ]; then
          sudo apt-get update
          sudo apt-get install -y gcc-11 g++-11
          echo "CC=gcc-11" >> $GITHUB_ENV
          echo "CXX=g++-11" >> $GITHUB_ENV
        elif [ "$RUNNER_OS" == "macOS" ]; then
          brew install gcc@11
          echo "CC=gcc-11" >> $GITHUB_ENV
          echo "CXX=g++-11" >> $GITHUB_ENV
        fi

    - name: Setup C++ (Linux/macOS Clang)
      if: matrix.os != 'windows-latest' && matrix.compiler == 'clang'
      run: |
        if [ "$RUNNER_OS" == "Linux" ]; then
          sudo apt-get update
          sudo apt-get install -y clang-15
          echo "CC=clang-15" >> $GITHUB_ENV
          echo "CXX=clang++-15" >> $GITHUB_ENV
        elif [ "$RUNNER_OS" == "macOS" ]; then
          echo "CC=clang" >> $GITHUB_ENV
          echo "CXX=clang++" >> $GITHUB_ENV
        fi

    - name: Setup MSVC (Windows)
      if: matrix.os == 'windows-latest' && matrix.compiler == 'msvc'
      uses: ilammy/msvc-dev-cmd@v1

    - name: Configure CMake
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: Test
      working-directory: build
      run: |
        if [ "$RUNNER_OS" == "Windows" ]; then
          ./Release/test_all.exe || ./test_all.exe
        else
          ./test_all
        fi
      shell: bash

  code-quality:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install static analysis tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          clang-format \
          clang-tidy \
          clang-tools \
          cppcheck \
          xmlstarlet \
          python3-pip
        
        # Python dependencies for advanced analysis
        pip3 install --user pyyaml

    - name: Check code formatting
      run: |
        echo "ğŸ¨ ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
        find include tests -name "*.h" -o -name "*.cpp" | xargs clang-format --dry-run --Werror

    - name: Run comprehensive static analysis
      run: |
        echo "ğŸ” åŒ…æ‹¬çš„é™çš„è§£æã‚’å®Ÿè¡Œä¸­..."
        
        # Bashç‰ˆã®é™çš„è§£æã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
        chmod +x scripts/static_analysis.sh
        ./scripts/static_analysis.sh --verbose
        
        # Pythonç‰ˆã®é™çš„è§£æã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œï¼ˆã‚ˆã‚Šè©³ç´°ãªåˆ†æï¼‰
        python3 scripts/run_static_analysis.py --verbose --enable-clang-analyzer
        
    - name: Run focused clang-tidy analysis
      run: |
        echo "ğŸ¯ é‡ç‚¹çš„clang-tidyè§£æã‚’å®Ÿè¡Œä¸­..."
        mkdir -p static_analysis_reports
        
        # ãƒ˜ãƒƒãƒ€ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å¯¾è±¡ï¼ˆãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¯é™¤å¤–ï¼‰
        find include/bluestl -name "*.h" -exec clang-tidy {} \
          --config-file=.clang-tidy \
          --header-filter=".*include/bluestl.*" \
          --export-fixes=static_analysis_reports/clang_tidy_fixes.yaml \
          -- -std=c++20 -Iinclude \; > static_analysis_reports/clang_tidy_ci.log 2>&1 || true
        
        # çµæœã®ã‚µãƒãƒªãƒ¼å‡ºåŠ›
        echo "ğŸ“Š clang-tidyçµæœã‚µãƒãƒªãƒ¼:"
        if [ -f static_analysis_reports/clang_tidy_ci.log ]; then
          ISSUE_COUNT=$(grep -c "warning:\|error:" static_analysis_reports/clang_tidy_ci.log || echo "0")
          echo "æ¤œå‡ºã•ã‚ŒãŸå•é¡Œæ•°: $ISSUE_COUNT"
          
          if [ "$ISSUE_COUNT" -gt 0 ]; then
            echo "ä¸»ãªå•é¡Œã‚«ãƒ†ã‚´ãƒª:"
            grep "warning:\|error:" static_analysis_reports/clang_tidy_ci.log | \
              sed 's/.*\[\(.*\)\].*/\1/' | \
              sort | uniq -c | sort -nr | head -5
          fi
        fi

    - name: Generate static analysis summary
      if: always()
      run: |
        echo "ğŸ“‹ é™çš„è§£æã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆä¸­..."
        
        SUMMARY_FILE="static_analysis_reports/ci_summary.md"
        
        cat > "$SUMMARY_FILE" << 'EOF'
        # BlueStl CI é™çš„è§£æãƒ¬ãƒãƒ¼ãƒˆ
        
        **å®Ÿè¡Œæ—¥æ™‚**: $(date)
        **ãƒ–ãƒ©ãƒ³ãƒ**: ${{ github.ref_name }}
        **ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}
        
        ## è§£æçµæœ
        
        EOF
        
        # clang-tidyçµæœ
        if [ -f static_analysis_reports/clang_tidy_ci.log ]; then
          CLANG_TIDY_ISSUES=$(grep -c "warning:\|error:" static_analysis_reports/clang_tidy_ci.log || echo "0")
          echo "### clang-tidy: $CLANG_TIDY_ISSUES ä»¶ã®å•é¡Œ" >> "$SUMMARY_FILE"
        fi
        
        # cppcheckçµæœï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
        CPPCHECK_FILES=$(ls static_analysis_reports/cppcheck_*.txt 2>/dev/null || true)
        if [ -n "$CPPCHECK_FILES" ]; then
          CPPCHECK_ISSUES=$(grep -c "error\|warning\|style\|performance\|portability" $CPPCHECK_FILES || echo "0")
          echo "### cppcheck: $CPPCHECK_ISSUES ä»¶ã®å•é¡Œ" >> "$SUMMARY_FILE"
        fi
        
        echo "" >> "$SUMMARY_FILE"
        echo "è©³ç´°ã¯å€‹åˆ¥ã®ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚" >> "$SUMMARY_FILE"
        
        # ã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
        cat "$SUMMARY_FILE"

    - name: Check for critical issues
      run: |
        echo "ğŸš¨ é‡è¦ãªå•é¡Œã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
        
        # ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒ™ãƒ«ã®å•é¡Œã‚’ãƒã‚§ãƒƒã‚¯
        ERROR_COUNT=0
        if [ -f static_analysis_reports/clang_tidy_ci.log ]; then
          ERROR_COUNT=$(grep -c "error:" static_analysis_reports/clang_tidy_ci.log || echo "0")
        fi
        
        echo "æ¤œå‡ºã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼æ•°: $ERROR_COUNT"
        
        # ç¾åœ¨ã¯ãƒ¯ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ¬ãƒ™ãƒ«ã§ç¶™ç¶šï¼ˆå°†æ¥çš„ã«ã¯ã‚¨ãƒ©ãƒ¼ã§åœæ­¢ã™ã‚‹å¯èƒ½æ€§ï¼‰
        if [ "$ERROR_COUNT" -gt 0 ]; then
          echo "âš ï¸ é™çš„è§£æã§ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸãŒã€ç¶™ç¶šã—ã¾ã™"
          echo "è©³ç´°ã¯é™çš„è§£æãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„"
        fi

    - name: Upload static analysis reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: static-analysis-reports-${{ matrix.os || 'ubuntu' }}-${{ github.sha }}
        path: static_analysis_reports/
        retention-days: 30

    - name: Comment PR with analysis results
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          // ã‚µãƒãƒªãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          const summaryPath = 'static_analysis_reports/ci_summary.md';
          
          if (fs.existsSync(summaryPath)) {
            const summary = fs.readFileSync(summaryPath, 'utf8');
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ” é™çš„è§£æçµæœ\n\n${summary}\n\nè©³ç´°ãªãƒ¬ãƒãƒ¼ãƒˆã¯[Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚`
            });
          }